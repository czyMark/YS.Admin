@{
	Layout = "~/Areas/System/Views/Shared/_Index.cshtml";
}
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment HostingEnvironment
@section header {
	@BundlerHelper.Render(HostingEnvironment.ContentRootPath, Url.Content("~/lib/zTree/v3/css/metroStyle/metroStyle.min.css"))
	@BundlerHelper.Render(HostingEnvironment.ContentRootPath, Url.Content("~/lib/zTree/v3/js/ztree.min.js"))

	@BundlerHelper.Render(HostingEnvironment.ContentRootPath, Url.Content("~/lib/jquery.layout/1.4.4/jquery.layout-latest.min.css"))
	@BundlerHelper.Render(HostingEnvironment.ContentRootPath, Url.Content("~/lib/jquery.layout/1.4.4/jquery.layout-latest.min.js"))
}

<div class="ui-layout-west">
	<div class="main-content">
		<div class="box box-main">
			<div class="box-header">
				<div class="box-title">
					站点栏目
				</div>
				<div class="box-tools pull-right">
					@* <a type="button" class="btn btn-box-tool menuItem" href="#"  title="管理部门"><i class="fa fa-edit"></i></a> *@
					<button type="button" class="btn btn-box-tool" id="btnExpand" title="展开" style="display:none;"><i class="fa fa-chevron-up"></i></button>
					<button type="button" class="btn btn-box-tool" id="btnCollapse" title="折叠"><i class="fa fa-chevron-down"></i></button>
					<button type="button" class="btn btn-box-tool" id="btnRefresh" title="刷新部门"><i class="fa fa-refresh"></i></button>
				</div>
			</div>
			<div class="ui-layout-content">
				<div id="articleCategoryTree" class="ztree"></div>
			</div>
		</div>
	</div>
</div>
<div class="container-div  ui-layout-center">
	<div class="row">
		<div id="searchDiv" class="col-sm-12 search-collapse">
			<input type="hidden" id="categoryId" col="CategoryId">
			<div class="select-list">
				<ul>
					<li>
						文章标题：<input id="title" col="Title" type="text" />
					</li>
					<li>
						<a id="btnSearch" class="btn btn-primary btn-sm" onclick="searchGrid()"><i class="fa fa-search"></i>&nbsp;搜索</a>
					</li>
				</ul>
			</div>
		</div>
		<div class="btn-group-sm hidden-xs" id="toolbar">
			<a id="btnAdd" class="btn btn-success disabled" onclick="showSaveForm(true)"><i class="fa fa-plus"></i> 新增</a>
			<a id="btnEdit" class="btn btn-primary disabled" onclick="showSaveForm(false)"><i class="fa fa-edit"></i> 修改</a>
			<a id="btnDelete" class="btn btn-danger disabled" onclick="deleteForm()"><i class="fa fa-remove"></i> 删除</a>
		</div>
		<div class="col-sm-12 select-table table-striped">
			<table id="gridTable" data-mobile-responsive="true"></table>
		</div>
	</div>
</div>

<script type="text/javascript">
	$(function () {
		initGrid();

		initTree();
		$('body').layout({ west__size: 185 });
	})

	function initTree() {
		$('#articleCategoryTree').ysTree({
			url: '@Url.Content("~/SiteManage/ArticleCategory/GetArticleCategoryTreeListJson")',
			async: true,
			expandLevel: 2,
			maxHeight: "700px",
			callback: {
				onClick: function (event, treeId, treeNode) {
					$("#categoryId").val(treeNode.id);
					searchGrid();
					if (parseFloat(treeNode.id) > 0) {
						$("#btnAdd").removeClass("disabled");
					}
					else {
						$("#btnAdd").addClass("disabled");
					}
				}
			}
		});
	}
	function initGrid() {
		var queryUrl = '@Url.Content("~/SiteManage/Articles/GetPageListJson")';
		$('#gridTable').ysTable({
			url: queryUrl,
			columns: [
				{ checkbox: true, visible: true },
				{ field: 'Id', title: 'Id', visible: false },
				{ field: 'Title', title: '标题' },
				{
					field: 'BaseCreateTime', title: '添加时间', formatter: function (value, row, index) {
						return ys.formatDate(value, "yyyy-MM-dd HH:mm:ss");
					}
				},
				{
					field: 'Status', title: '状态', formatter: function (value, row, index) {
						if (row.Status == "@ShowEmum.Yes.ParseToInt()") {
							return '<span class="badge badge-primary">' + "@ShowEmum.Yes.GetDescription()" + '</span>';
						} else {
							return '<span class="badge badge-warning">' + "@ShowEmum.No.GetDescription()" + '</span>';
						}
					}
				},
				{
					title: '操作',
					align: 'center',
					formatter: function (value, row, index) {
						var actions = [];
						actions.push('<a class="btn btn-success btn-xs " href="javascript:void(0)" onclick="showEdit(\'' + row.Id + '\')"><i class="fa fa-edit"></i>编辑</a> ');
						actions.push('<a class="btn btn-success btn-xs " href="javascript:void(0)" onclick="showListEdit(\'' + row.Id + '\')"><i class="fa fa-edit"></i>附加数据维护</a> ');
						return actions.join('');
					}
				}
			],
			queryParams: function (params) {

				var pagination = $('#gridTable').ysTable('getPagination', params);
				var queryString = $('#searchDiv').getWebControls(pagination);

				return queryString;
			}
		});
	}

	function searchGrid() {
		$('#gridTable').ysTable('search');
		resetToolbarStatus();
	}

	function showSaveForm(bAdd) {
		var id = 0;
		var categoryId = $("#categoryId").val();
		if (!bAdd) {
			var selectedRow = $('#gridTable').bootstrapTable('getSelections');
			if (!ys.checkRowEdit(selectedRow)) {
				return;
			}
			else {
				id = selectedRow[0].Id;
			}
		}
		showEdit(id);
	}
	function showEdit(id) {
		var categoryId = $("#categoryId").val();
		ys.openDialog({
			title: id > 0 ? '编辑' : '添加',
			content: '@Url.Content("~/SiteManage/Articles/ArticlesForm")' + '?categoryId=' + categoryId + '&id=' + id,
			width: '100%',
			height: '100%',
			callback: function (index, layero) {
				var iframeWin = window[layero.find('iframe')[0]['name']];
				iframeWin.saveForm(index);
			}
		});
	}

	function showListEdit(id) {
		var categoryId = $("#categoryId").val();
		ys.openDialog({
			title: '附加数据维护',
			content: '@Url.Content("~/SiteManage/ArticlesDescriptiondata/ArticlesDescriptiondataIndex")' + '?categoryId=' + categoryId + '&id=' + id,
			width: '100%',
			height: '100%',
			btn: [],
			callback: function (index, layero) {
				var iframeWin = window[layero.find('iframe')[0]['name']];
				iframeWin.saveForm(index);
			}
		});
	}
	function deleteForm() {
		var selectedRow = $('#gridTable').bootstrapTable('getSelections');
		if (ys.checkRowDelete(selectedRow)) {
			ys.confirm('确认要删除选中的' + selectedRow.length + '条数据吗？', function () {
				var ids = ys.getIds(selectedRow);
				ys.ajax({
					url: '@Url.Content("~/SiteManage/Articles/DeleteFormJson")' + '?ids=' + ids,
					type: 'post',
					success: function (obj) {
						if (obj.Tag == 1) {
							ys.msgSuccess(obj.Message);
							searchGrid();
						}
						else {
							ys.msgError(obj.Message);
						}
					}
				});
			});
		}
	}
</script>

@{
    Layout = "~/Areas/System/Views/Shared/_FormWhite.cshtml";
}

@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment HostingEnvironment
@section header {
    @BundlerHelper.Render(HostingEnvironment.ContentRootPath, Url.Content("~/lib/bootstrap.treetable/1.0/bootstrap-treetable.min.css"))
    @BundlerHelper.Render(HostingEnvironment.ContentRootPath, Url.Content("~/lib/bootstrap.treetable/1.0/bootstrap-treetable.min.js"))

    @BundlerHelper.Render(HostingEnvironment.ContentRootPath, Url.Content("~/lib/jquery.ui/1.12.1/jquery-ui.min.css"))
    @BundlerHelper.Render(HostingEnvironment.ContentRootPath, Url.Content("~/lib/jquery.ui/1.12.1/jquery-ui.min.js"))

    @BundlerHelper.Render(HostingEnvironment.ContentRootPath, Url.Content("~/lib/jquery.smartwizard/4.0.1/css/smart_wizard.min.css"))
    @BundlerHelper.Render(HostingEnvironment.ContentRootPath, Url.Content("~/lib/jquery.smartwizard/4.0.1/css/smart_wizard.min.js"))

    @BundlerHelper.Render(HostingEnvironment.ContentRootPath, Url.Content("~/lib/highlight/9.13.1/css/vs.min.css"))
    @BundlerHelper.Render(HostingEnvironment.ContentRootPath, Url.Content("~/lib/jquery.ui/1.12.1/highlight.pack.min.js"))
}

<style>
    .div-step {
        overflow: hidden;
    }

    .div-step-container {
        height: 400px;
        overflow-y: auto
    }

    .droppable-active {
        background-color: #ffe !important
    }

    .tools a {
        cursor: pointer;
        font-size: 80%;
        margin-right: 6px;
    }

    .draggable {
        cursor: move
    }
</style>
<div style="padding:0 10px;">
    <div id="smartwizard">
        <ul>
            <li><a href="#step-1">1<br />基本配置</a></li>
            <li><a href="#step-2">2<br />代码预览</a></li>
            <li><a href="#step-3">3<br />生成完毕</a></li>
        </ul>
        <div>
            <div id="step-1" class="div-step">
                <div class="div-step-container">
                    <div class="panel panel-default" style="margin-bottom:5px">
                        <div class="panel-heading">
                            <h3 class="panel-title">
                                文件名配置
                            </h3>
                        </div>
                        <div class="panel-body">
                            <form id="fileConfigForm" class="form-horizontal m">
                                <div class="form-group">
                                    <div class="col-sm-4">
                                        <label class="col-sm-4 control-label ">类名前缀<font class="red"> *</font></label>
                                        <div class="col-sm-8">
                                            <input id="classPrefix" col="ClassPrefix" type="text" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <label class="col-sm-4 control-label ">类名描述</label>
                                        <div class="col-sm-8">
                                            <input id="classDescription" col="ClassDescription" type="text" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <label class="col-sm-4 control-label ">创建人员</label>
                                        <div class="col-sm-8">
                                            <input id="createName" col="CreateName" type="text" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-sm-4">
                                        <label class="col-sm-4 control-label ">实体类名<font class="red"> *</font></label>
                                        <div class="col-sm-8">
                                            <input id="entityName" col="EntityName" type="text" data-suffix="Entity" readonly="readonly" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <label class="col-sm-4 control-label ">映射类名<font class="red"> *</font></label>
                                        <div class="col-sm-8">
                                            <input id="entityMapName" col="EntityMapName" type="text" data-suffix="EntityMap" readonly="readonly" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <label class="col-sm-4 control-label ">创建日期</label>
                                        <div class="col-sm-8">
                                            <input id="createDate" col="CreateDate" type="text" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-sm-4">
                                        <label class="col-sm-4 control-label ">业务类名<font class="red"> *</font></label>
                                        <div class="col-sm-8">
                                            <input id="businessName" col="BusinessName" type="text" data-suffix="BLL" readonly="readonly" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <label class="col-sm-4 control-label ">服务类名<font class="red"> *</font></label>
                                        <div class="col-sm-8">
                                            <input id="serviceName" col="ServiceName" type="text" data-suffix="Service" readonly="readonly" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <label class="col-sm-4 control-label ">查询类名<font class="red"> *</font></label>
                                        <div class="col-sm-8">
                                            <input id="entityParamName" col="EntityParamName" type="text" data-suffix="Param" readonly="readonly" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="panel panel-default" style="margin-bottom:0px">
                        <div class="panel-heading">
                            <h3 class="panel-title">
                                输出目录
                            </h3>
                        </div>
                        <div class="panel-body">
                            <form id="outputConfigForm" class="form-horizontal m">
                                <div class="form-group">
                                    <label class="col-sm-2 control-label ">输出到所在模块<font class="red"> *</font></label>
                                    <div class="col-sm-10">
                                        <div id="outputModule" col="OutputModule"></div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label ">实体层输出目录<font class="red"> *</font></label>
                                    <div class="col-sm-10">
                                        <input id="outputEntity" col="OutputEntity" type="text" readonly="readonly" class="form-control" />
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label ">业务层输出目录<font class="red"> *</font></label>
                                    <div class="col-sm-10">
                                        <input id="outputBusiness" col="OutputBusiness" type="text" readonly="readonly" class="form-control" />
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div id="step-2" class="div-step">
                <ul class="nav nav-tabs">
                    <li class="active"><a href="#codeEntity" data-toggle="tab">实体类</a></li>
                    <li><a href="#codeEntityParam" data-toggle="tab">实体查询类</a></li>
                    <li><a href="#codeService" data-toggle="tab">服务类</a></li>
                    <li><a href="#codeBusiness" data-toggle="tab">业务类</a></li>  
                </ul>
                <div class="div-step-container" style="height:360px">
                    <div class="tab-content">
                        <div class="tab-pane fade in active" id="codeEntity" col="CodeEntity">
                        </div>
                        <div class="tab-pane fade" id="codeEntityParam" col="CodeEntityParam">
                        </div>
                        <div class="tab-pane fade" id="codeService" col="CodeService">
                        </div>
                        <div class="tab-pane fade" id="codeBusiness" col="CodeBusiness">
                        </div> 
                    </div>
                </div>
            </div>
            <div id="step-3" class="div-step">
                <div class="div-step-container">
                    <h5>输出文件位置：</h5>
                    <form id="outputListForm" class="form-horizontal m"></form>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var tableName = ys.request("tableName");
    var tableNameUpper = ''; //首字母大写的表名
    var outputModule = '@ViewBag.OutputModule'; //解决页面刷新后output module值丢失
    var codeList; //预览的代码
    $(function () {

        classPrefixChange();

        $("#fileConfigForm").validate({
            rules: {
                classPrefix: { required: true }
            }
        });

        $("#outputConfigForm").validate({
            rules: {
                outputModule_select: { required: true }
            }
        });
         

        loadInitialConfig();

        $("#n_columns").on("change", function () {
            var v = $(this).val();
            if (v === "1") {
                var $col = $(".form-body .col-md-12").toggle(true);
                $(".form-body .col-md-6 .draggable").each(function (i, el) {
                    $(this).remove().appendTo($col);
                });
                $(".form-body .col-md-6").toggle(false);
            } else {
                var $col = $(".form-body .col-md-6").toggle(true);

                $(".form-body .col-md-12 .draggable").each(function (i, el) {
                    $(this).remove().appendTo(i % 2 ? $col[1] : $col[0]);
                });
                $(".form-body .col-md-12").toggle(false);
            }
        });

        $("#smartwizard").on("leaveStep", function (e, anchorObject, stepNumber, stepDirection) {
            switch (stepNumber + 1) {
                case 1:
                    if (!$("#step-1").validate().form()) {
                        return false;
                    }
                    codePreview();
                    break;
                case 2:
                    codeGenerate(); break;
                case 3:
                    break;
                case 4:
                    break;
                case 5: break;
            }
            return true;
        });

        // Smart Wizard
        $('#smartwizard').smartWizard({
            selected: 0,
            theme: 'arrows',
            transitionEffect: 'fade',
            toolbarSettings: {
                toolbarPosition: 'bottom',
                toolbarExtraButtons: [{ label: ' 完成', css: 'btn-info', onClick: function () { ys.closeDialog(); } }]
            }
        });

        $("#reset-btn").on("click", function () {
            $('#smartwizard').smartWizard("reset");
            return true;
        });

        $("#prev-btn").on("click", function () {
            $('#smartwizard').smartWizard("prev");
            return true;
        });

        $("#next-btn").on("click", function () {
            $('#smartwizard').smartWizard("next");
            return true;
        });

    });

    function classPrefixChange() {
        $("#classPrefix").keyup(function () {
            var classPrefix = $(this).val();
            $("#fileConfigForm input").each(function (i, ele) {
                var suffix = $(ele).attr("data-suffix");
                if (!ys.isNullOrEmpty(suffix)) {
                    $(ele).val(classPrefix + $(ele).attr("data-suffix"));
                }
            });
        });
    }
     

    function loadInitialConfig() {
        ys.ajax({
            url: '@Url.Content("~/ToolManage/CodeGenerator/GetBaseConfigJson")' + '?tableName=' + tableName,
            type: "get",
            success: function (obj) {
                if (obj.Tag == 1) {
                    var result = obj.Data;
                    tableNameUpper = result.TableNameUpper;
                    $("#fileConfigForm").setWebControls(result.FileConfig);
                    $("#outputConfigForm").setWebControls(result.OutputConfig);

                    $("#outputModule").ysComboBox({ data: result.OutputConfig.ModuleList, class: "form-control" });
                    $("select.select2").each(function () {
                        $(this).select2();
                        if (!ys.isNullOrEmpty(outputModule)) {
                            $("#outputModule").ysComboBox('setValue', outputModule);
                        }
                        $(this).on("change", function (e) {
                            outputModule = $("#outputModule").ysComboBox('getValue');
                            if (!ys.isNullOrEmpty(outputModule)) {
                                //  window.location.href = ys.changeURLParam(window.location.href, "outputModule", outputModule);
                            }
                        });
                    }) 

                }
            }
        });
    }

    // 把属性名称的第一个字母转为大写
    function GetFieldId(field) {
        field = field[0].toLowerCase() + field.substring(1);
        return field;
    }
     

    function codePreview() {
        var postData = {};
        postData.TableName = tableName;
        postData.FileConfig = $("#fileConfigForm").getWebControls();
        postData.OutputConfig = $("#outputConfigForm").getWebControls();
        postData.Type = "2";

        ys.ajax({
            url: '@Url.Content("~/ToolManage/CodeGenerator/CodePreviewJson")',
            type: "post",
            async: false,
            data: postData,
            success: function (obj) {
                if (obj.Tag == 1) {
                    var result = obj.Data;
                    $("div.tab-pane").each(function (i, ele) {
                        var col = $(ele).attr("col");
                        if (col == "CodeMenu") {
                            $(this).html("<pre class='no-padding no-margin no-top-border'><code class='html'>" + result[col] + "</code></pre>");
                        }
                        else {
                            $(this).html("<pre class='no-padding no-margin no-top-border'><code class='csharp'>" + result[col] + "</code></pre>");
                        }
                    });
                    $('pre code').each(function (i, ele) {
                        hljs.highlightBlock(ele)
                    });
                    codeList = result;
                }
                else {
                    ys.msgError(obj.Message);
                }
            }
        });
    }

    function codeGenerate() {
        var postData = {};
        postData.TableName = tableName;
        postData.FileConfig = $("#fileConfigForm").getWebControls();
        postData.OutputConfig = $("#outputConfigForm").getWebControls();
        postData.Code = encodeURIComponent(JSON.stringify(codeList));
        postData.Type = "2";
        ys.ajax({
            url: '@Url.Content("~/ToolManage/CodeGenerator/CodeGenerateJson")',
            type: "post",
            async: false,
            data: postData,
            success: function (obj) {
                $("#outputListForm").find("div").remove();
                if (obj.Tag == 1) {
                    for (var i = 0; i < obj.Data.length; i++) {
                        var html = "<div class='form-group'><label class='col-sm-2 control-label'>" + obj.Data[i].Key + "</label>" +
                            "<label class='col-sm-10 control-label' style='text-align:left'>" + obj.Data[i].Value + "</label></div>";
                        $("#outputListForm").append(html);
                    }
                }
                else {
                    ys.msgError(obj.Message);
                }
            }
        });
    }
     
</script>
